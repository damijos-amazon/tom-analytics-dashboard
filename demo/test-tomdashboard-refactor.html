<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOMDashboard Refactor Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            margin-top: 0;
            color: #232f3e;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.pass {
            background-color: #d4edda;
            color: #155724;
        }
        .status.fail {
            background-color: #f8d7da;
            color: #721c24;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #232f3e;
            color: white;
        }
        .positive { color: green; }
        .negative { color: red; }
        .neutral { color: gray; }
        .table-row { cursor: move; }
        .btn-delete {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>TOMDashboard Refactor Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Legacy Constructor (Backward Compatibility)</h2>
        <p>Testing that the old constructor signature still works...</p>
        <div id="test1-result"></div>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Prior Month</th>
                    <th>Current Month</th>
                    <th>Change</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="legacyTableBody"></tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>Test 2: New TableConfig Constructor</h2>
        <p>Testing the new tableConfig object parameter...</p>
        <div id="test2-result"></div>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Prior Month</th>
                    <th>Current Month</th>
                    <th>Change</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="configTableBody"></tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>Test 3: Custom Columns with Dynamic Rendering</h2>
        <p>Testing custom column schema with different data types...</p>
        <div id="test3-result"></div>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Employee</th>
                    <th>Score</th>
                    <th>Accuracy</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="customTableBody"></tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>Test 4: Column Mapping and File Parsing</h2>
        <p>Testing Excel column mapping (A, B, C) to table columns...</p>
        <div id="test4-result"></div>
        <pre id="test4-output"></pre>
    </div>

    <script src="js/script-clean.js"></script>
    <script>
        // Test utilities
        function showResult(elementId, passed, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<span class="status ${passed ? 'pass' : 'fail'}">${passed ? 'PASS' : 'FAIL'}</span> ${message}`;
        }

        // Test 1: Legacy Constructor
        function test1() {
            try {
                const dashboard = new TOMDashboard('legacyTableBody', 'podium1', 'test_legacy_data');
                
                // Add test data
                dashboard.data = [
                    { name: 'John Doe', priorMonth: 95.5, currentMonth: 97.2, change: 1.7, status: 'Improved' },
                    { name: 'Jane Smith', priorMonth: 92.0, currentMonth: 94.5, change: 2.5, status: 'Excellent' }
                ];
                
                dashboard.renderTable();
                
                // Verify
                const hasDefaultColumns = dashboard.columns && dashboard.columns.length === 5;
                const hasCorrectIds = dashboard.columns[0].id === 'name' && 
                                      dashboard.columns[1].id === 'priorMonth';
                const tableRendered = document.getElementById('legacyTableBody').children.length === 2;
                
                const passed = hasDefaultColumns && hasCorrectIds && tableRendered;
                showResult('test1-result', passed, 
                    `Constructor accepts legacy parameters. Default columns: ${hasDefaultColumns}, Correct IDs: ${hasCorrectIds}, Rendered: ${tableRendered}`);
            } catch (error) {
                showResult('test1-result', false, `Error: ${error.message}`);
            }
        }

        // Test 2: New TableConfig Constructor
        function test2() {
            try {
                const tableConfig = {
                    tableBodyId: 'configTableBody',
                    tableName: 'Test Table',
                    storageKey: 'test_config_data',
                    direction: 'higher',
                    defaultBenchmark: 95,
                    columns: null // Use default columns
                };
                
                const dashboard = new TOMDashboard(tableConfig);
                
                // Add test data
                dashboard.data = [
                    { name: 'Alice Brown', priorMonth: 88.0, currentMonth: 92.0, change: 4.0, status: 'Excellent' },
                    { name: 'Bob Wilson', priorMonth: 90.0, currentMonth: 89.0, change: -1.0, status: 'Decreased' }
                ];
                
                dashboard.renderTable();
                
                // Verify
                const hasConfig = dashboard.tableConfig !== null;
                const hasDirection = dashboard.direction === 'higher';
                const hasBenchmark = dashboard.defaultBenchmark === 95;
                const tableRendered = document.getElementById('configTableBody').children.length === 2;
                
                const passed = hasConfig && hasDirection && hasBenchmark && tableRendered;
                showResult('test2-result', passed, 
                    `Constructor accepts tableConfig object. Config: ${hasConfig}, Direction: ${hasDirection}, Benchmark: ${hasBenchmark}, Rendered: ${tableRendered}`);
            } catch (error) {
                showResult('test2-result', false, `Error: ${error.message}`);
            }
        }

        // Test 3: Custom Columns
        function test3() {
            try {
                const tableConfig = {
                    tableBodyId: 'customTableBody',
                    tableName: 'Custom Table',
                    storageKey: 'test_custom_data',
                    direction: 'higher',
                    defaultBenchmark: 90,
                    columns: [
                        { id: 'employee', label: 'Employee', dataType: 'text', visible: true },
                        { id: 'score', label: 'Score', dataType: 'number', visible: true },
                        { id: 'accuracy', label: 'Accuracy', dataType: 'percentage', visible: true },
                        { id: 'date', label: 'Date', dataType: 'date', visible: true }
                    ]
                };
                
                const dashboard = new TOMDashboard(tableConfig);
                
                // Add test data with custom columns
                dashboard.data = [
                    { employee: 'Charlie Davis', score: 95.5, accuracy: 98.2, date: '2024-01-15' },
                    { employee: 'Diana Evans', score: 92.0, accuracy: 96.5, date: '2024-01-16' }
                ];
                
                dashboard.renderTable();
                
                // Verify
                const hasCustomColumns = dashboard.columns && dashboard.columns.length === 4;
                const firstColumnIsEmployee = dashboard.columns[0].id === 'employee';
                const tableRendered = document.getElementById('customTableBody').children.length === 2;
                const cellCount = document.getElementById('customTableBody').children[0].children.length;
                
                const passed = hasCustomColumns && firstColumnIsEmployee && tableRendered && cellCount === 6; // rank + 4 columns + actions
                showResult('test3-result', passed, 
                    `Custom columns rendered. Columns: ${hasCustomColumns}, First is employee: ${firstColumnIsEmployee}, Rendered: ${tableRendered}, Cell count: ${cellCount}`);
            } catch (error) {
                showResult('test3-result', false, `Error: ${error.message}`);
            }
        }

        // Test 4: Column Mapping
        function test4() {
            try {
                const tableConfig = {
                    tableBodyId: 'mappingTableBody',
                    tableName: 'Mapping Test',
                    storageKey: 'test_mapping_data',
                    direction: 'higher',
                    defaultBenchmark: 90,
                    columns: [
                        { id: 'name', label: 'Name', dataType: 'text', visible: true, fileColumnMapping: 'A' },
                        { id: 'value', label: 'Value', dataType: 'number', visible: true, fileColumnMapping: 'C' }
                    ]
                };
                
                const dashboard = new TOMDashboard(tableConfig);
                
                // Test Excel column to index conversion
                const indexA = dashboard.excelColumnToIndex('A');
                const indexB = dashboard.excelColumnToIndex('B');
                const indexC = dashboard.excelColumnToIndex('C');
                const indexAA = dashboard.excelColumnToIndex('AA');
                
                // Test file parsing with column mapping
                const mockData = [
                    ['Name', 'Unused', 'Value'],
                    ['Test User', 'Ignore', '95.5'],
                    ['Another User', 'Skip', '88.0']
                ];
                
                const parsed = dashboard.parseFileData(mockData, 'test-file.csv');
                
                const indexCorrect = indexA === 0 && indexB === 1 && indexC === 2 && indexAA === 26;
                const parsedCorrect = parsed.length === 2 && parsed[0].name === 'Test User' && parsed[0].value === 95.5;
                
                const passed = indexCorrect && parsedCorrect;
                const output = `
Excel Column Mapping:
- A → ${indexA} (expected 0) ✓
- B → ${indexB} (expected 1) ✓
- C → ${indexC} (expected 2) ✓
- AA → ${indexAA} (expected 26) ✓

Parsed Data:
${JSON.stringify(parsed, null, 2)}

Expected: 2 rows with name and value from columns A and C
Actual: ${parsed.length} rows, first row name="${parsed[0]?.name}", value=${parsed[0]?.value}
                `;
                
                document.getElementById('test4-output').textContent = output;
                showResult('test4-result', passed, 
                    `Column mapping works. Index conversion: ${indexCorrect}, Parsing: ${parsedCorrect}`);
            } catch (error) {
                showResult('test4-result', false, `Error: ${error.message}`);
                document.getElementById('test4-output').textContent = error.stack;
            }
        }

        // Run all tests
        window.addEventListener('DOMContentLoaded', () => {
            // Prevent global dashboard initialization
            window.dashboards = {};
            
            setTimeout(() => {
                test1();
                test2();
                test3();
                test4();
            }, 100);
        });
    </script>
</body>
</html>
