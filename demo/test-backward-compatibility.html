<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backward Compatibility Test Suite</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #232F3E;
            border-bottom: 3px solid #FF9900;
            padding-bottom: 10px;
        }
        
        .test-suite {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-case {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ccc;
            background-color: #f8f9fa;
        }
        
        .test-case.passed {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        
        .test-case.failed {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .test-case.running {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        
        .test-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .test-result {
            font-size: 13px;
            color: #666;
        }
        
        .summary {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-card {
            flex: 1;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card.passed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .summary-card.failed {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .summary-card.total {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .summary-number {
            font-size: 36px;
            font-weight: 700;
        }
        
        .summary-label {
            font-size: 14px;
            margin-top: 5px;
        }
        
        button {
            background-color: #FF9900;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 10px 5px;
        }
        
        button:hover {
            background-color: #EC7211;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .log-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üß™ Backward Compatibility Test Suite</h1>
    
    <div class="test-suite">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
        <button onclick="setupTestEnvironment()">üîß Setup Test Environment</button>
        <button onclick="clearTestData()">üóëÔ∏è Clear Test Data</button>
    </div>
    
    <div class="test-suite">
        <h2>Test Summary</h2>
        <div class="summary">
            <div class="summary-card total">
                <div class="summary-number" id="totalTests">0</div>
                <div class="summary-label">Total Tests</div>
            </div>
            <div class="summary-card passed">
                <div class="summary-number" id="passedTests">0</div>
                <div class="summary-label">Passed</div>
            </div>
            <div class="summary-card failed">
                <div class="summary-number" id="failedTests">0</div>
                <div class="summary-label">Failed</div>
            </div>
        </div>
    </div>
    
    <div class="test-suite">
        <h2>Test Results</h2>
        <div id="testResults"></div>
    </div>
    
    <div class="test-suite">
        <h2>Detailed Log</h2>
        <div id="detailedLog" class="log-output">Test log will appear here...</div>
    </div>

    <script src="js/migration-utility.js"></script>
    <script src="js/table-config-system.js"></script>
    <script>
        // Test framework
        class BackwardCompatibilityTests {
            constructor() {
                this.tests = [];
                this.results = [];
                this.migrationUtility = new MigrationUtility();
                this.configSystem = null;
            }
            
            // Add test
            addTest(name, description, testFn) {
                this.tests.push({ name, description, testFn });
            }
            
            // Log helper
            log(message, type = 'info') {
                const output = document.getElementById('detailedLog');
                const timestamp = new Date().toLocaleTimeString();
                const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
                output.scrollTop = output.scrollHeight;
                console.log(message);
            }
            
            // Run all tests
            async runAll() {
                this.results = [];
                this.log('Starting backward compatibility test suite...', 'info');
                
                for (const test of this.tests) {
                    await this.runTest(test);
                }
                
                this.displayResults();
                this.log('Test suite completed', 'success');
            }
            
            // Run single test
            async runTest(test) {
                this.log(`\n--- Running: ${test.name} ---`, 'info');
                this.updateTestUI(test.name, 'running');
                
                try {
                    const result = await test.testFn();
                    
                    if (result.passed) {
                        this.log(`‚úÖ PASSED: ${test.name}`, 'success');
                        this.results.push({ name: test.name, passed: true, message: result.message });
                        this.updateTestUI(test.name, 'passed', result.message);
                    } else {
                        this.log(`‚ùå FAILED: ${test.name} - ${result.message}`, 'error');
                        this.results.push({ name: test.name, passed: false, message: result.message });
                        this.updateTestUI(test.name, 'failed', result.message);
                    }
                } catch (error) {
                    this.log(`‚ùå ERROR: ${test.name} - ${error.message}`, 'error');
                    this.results.push({ name: test.name, passed: false, message: error.message });
                    this.updateTestUI(test.name, 'failed', error.message);
                }
            }
            
            // Update test UI
            updateTestUI(testName, status, message = '') {
                const resultsDiv = document.getElementById('testResults');
                let testDiv = document.getElementById(`test-${testName.replace(/\s/g, '-')}`);
                
                if (!testDiv) {
                    testDiv = document.createElement('div');
                    testDiv.id = `test-${testName.replace(/\s/g, '-')}`;
                    testDiv.className = 'test-case';
                    resultsDiv.appendChild(testDiv);
                }
                
                testDiv.className = `test-case ${status}`;
                testDiv.innerHTML = `
                    <div class="test-title">${testName}</div>
                    <div class="test-result">${message}</div>
                `;
            }
            
            // Display results summary
            displayResults() {
                const passed = this.results.filter(r => r.passed).length;
                const failed = this.results.filter(r => !r.passed).length;
                const total = this.results.length;
                
                document.getElementById('totalTests').textContent = total;
                document.getElementById('passedTests').textContent = passed;
                document.getElementById('failedTests').textContent = failed;
                
                this.log(`\n=== Test Summary ===`, 'info');
                this.log(`Total: ${total}, Passed: ${passed}, Failed: ${failed}`, 'info');
                
                if (failed === 0) {
                    this.log('üéâ All tests passed!', 'success');
                } else {
                    this.log(`‚ö†Ô∏è ${failed} test(s) failed`, 'warning');
                }
            }
        }
        
        // Initialize test suite
        const testSuite = new BackwardCompatibilityTests();
        
        // Setup test environment
        function setupTestEnvironment() {
            testSuite.log('Setting up test environment...', 'info');
            
            // Clear existing data
            localStorage.clear();
            
            // Create legacy test data for all 6 tables
            const testData = [
                { name: 'Test User 1', priorMonth: 95, currentMonth: 98, change: 3, status: 'improved' },
                { name: 'Test User 2', priorMonth: 92, currentMonth: 94, change: 2, status: 'improved' },
                { name: 'Test User 3', priorMonth: 88, currentMonth: 85, change: -3, status: 'declined' }
            ];
            
            localStorage.setItem('tom_analytics_data', JSON.stringify(testData));
            localStorage.setItem('tom_analytics_data_2', JSON.stringify(testData));
            localStorage.setItem('tom_analytics_data_3', JSON.stringify(testData));
            localStorage.setItem('tom_analytics_data_4', JSON.stringify(testData));
            localStorage.setItem('tom_analytics_data_5', JSON.stringify(testData));
            localStorage.setItem('tom_analytics_data_6', JSON.stringify(testData));
            
            testSuite.log('‚úÖ Test environment ready', 'success');
        }
        
        // Clear test data
        function clearTestData() {
            if (confirm('Clear all test data?')) {
                localStorage.clear();
                testSuite.log('‚úÖ Test data cleared', 'success');
            }
        }
        
        // Define tests
        
        // Test 1: Legacy table ID mapping
        testSuite.addTest(
            'Legacy Table ID Mapping',
            'Verify legacy tableBodyId values map to new tableId values',
            async () => {
                const mappings = [
                    { legacy: 'tableBody', expected: 'vti-compliance' },
                    { legacy: 'tableBody2', expected: 'vti-dpmo' },
                    { legacy: 'tableBody3', expected: 'ta-idle-time' },
                    { legacy: 'tableBody4', expected: 'seal-validation' },
                    { legacy: 'tableBody5', expected: 'ppo-compliance' },
                    { legacy: 'tableBody6', expected: 'andon-response-time' }
                ];
                
                for (const mapping of mappings) {
                    const result = testSuite.migrationUtility.mapLegacyTableId(mapping.legacy);
                    if (result !== mapping.expected) {
                        return { passed: false, message: `${mapping.legacy} mapped to ${result}, expected ${mapping.expected}` };
                    }
                }
                
                return { passed: true, message: 'All 6 legacy table IDs mapped correctly' };
            }
        );
        
        // Test 2: Reverse table ID mapping
        testSuite.addTest(
            'Reverse Table ID Mapping',
            'Verify new tableId values map back to legacy tableBodyId',
            async () => {
                const mappings = [
                    { tableId: 'vti-compliance', expected: 'tableBody' },
                    { tableId: 'vti-dpmo', expected: 'tableBody2' },
                    { tableId: 'ta-idle-time', expected: 'tableBody3' },
                    { tableId: 'seal-validation', expected: 'tableBody4' },
                    { tableId: 'ppo-compliance', expected: 'tableBody5' },
                    { tableId: 'andon-response-time', expected: 'tableBody6' }
                ];
                
                for (const mapping of mappings) {
                    const result = testSuite.migrationUtility.mapToLegacyTableId(mapping.tableId);
                    if (result !== mapping.expected) {
                        return { passed: false, message: `${mapping.tableId} mapped to ${result}, expected ${mapping.expected}` };
                    }
                }
                
                return { passed: true, message: 'All 6 reverse mappings work correctly' };
            }
        );
        
        // Test 3: Data preservation during migration
        testSuite.addTest(
            'Data Preservation',
            'Verify all table data is preserved during migration',
            async () => {
                // Setup test data
                setupTestEnvironment();
                
                // Get original data
                const originalData = {};
                for (let i = 1; i <= 6; i++) {
                    const key = i === 1 ? 'tom_analytics_data' : `tom_analytics_data_${i}`;
                    originalData[key] = localStorage.getItem(key);
                }
                
                // Run migration
                const result = testSuite.migrationUtility.migrate();
                
                if (!result.success) {
                    return { passed: false, message: `Migration failed: ${result.error}` };
                }
                
                // Verify data is preserved
                for (let i = 1; i <= 6; i++) {
                    const key = i === 1 ? 'tom_analytics_data' : `tom_analytics_data_${i}`;
                    const migratedData = localStorage.getItem(key);
                    
                    if (!migratedData) {
                        return { passed: false, message: `Data missing for ${key}` };
                    }
                    
                    const original = JSON.parse(originalData[key]);
                    const migrated = JSON.parse(migratedData);
                    
                    if (original.length !== migrated.length) {
                        return { passed: false, message: `Record count mismatch for ${key}` };
                    }
                }
                
                return { passed: true, message: 'All 6 tables preserved data correctly' };
            }
        );
        
        // Test 4: Migration backup creation
        testSuite.addTest(
            'Migration Backup Creation',
            'Verify migration creates backup before modifying data',
            async () => {
                setupTestEnvironment();
                
                const result = testSuite.migrationUtility.migrate();
                
                if (!result.success) {
                    return { passed: false, message: 'Migration failed' };
                }
                
                // Check for backup
                let backupFound = false;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('migration_backup_')) {
                        backupFound = true;
                        break;
                    }
                }
                
                if (!backupFound) {
                    return { passed: false, message: 'No migration backup created' };
                }
                
                return { passed: true, message: 'Migration backup created successfully' };
            }
        );
        
        // Test 5: Migration verification
        testSuite.addTest(
            'Migration Verification',
            'Verify migration verification function works correctly',
            async () => {
                setupTestEnvironment();
                testSuite.migrationUtility.migrate();
                
                const verification = testSuite.migrationUtility.verifyMigration();
                
                if (!verification.success) {
                    return { passed: false, message: `Verification failed: ${verification.errors.join(', ')}` };
                }
                
                return { passed: true, message: 'Migration verification passed' };
            }
        );
        
        // Test 6: Legacy backup import (array format)
        testSuite.addTest(
            'Legacy Backup Import - Array Format',
            'Verify legacy backup in array format can be imported',
            async () => {
                const legacyBackup = [
                    { name: 'Test 1', priorMonth: 90, currentMonth: 95 },
                    { name: 'Test 2', priorMonth: 85, currentMonth: 88 }
                ];
                
                try {
                    const converted = testSuite.migrationUtility.importLegacyBackup(legacyBackup);
                    
                    if (!converted.version || !converted.tables) {
                        return { passed: false, message: 'Converted backup missing required fields' };
                    }
                    
                    return { passed: true, message: 'Array format backup converted successfully' };
                } catch (error) {
                    return { passed: false, message: error.message };
                }
            }
        );
        
        // Test 7: Legacy backup import (object format)
        testSuite.addTest(
            'Legacy Backup Import - Object Format',
            'Verify legacy backup in object format can be imported',
            async () => {
                const legacyBackup = {
                    tom_analytics_data: '[{"name":"Test 1"}]',
                    tom_analytics_data_2: '[{"name":"Test 2"}]',
                    timestamp: '2024-01-01T00:00:00.000Z'
                };
                
                try {
                    const converted = testSuite.migrationUtility.importLegacyBackup(legacyBackup);
                    
                    if (!converted.version || !converted.tables) {
                        return { passed: false, message: 'Converted backup missing required fields' };
                    }
                    
                    if (!converted.tables.tom_analytics_data) {
                        return { passed: false, message: 'Table data not preserved' };
                    }
                    
                    return { passed: true, message: 'Object format backup converted successfully' };
                } catch (error) {
                    return { passed: false, message: error.message };
                }
            }
        );
        
        // Test 8: New format backup recognition
        testSuite.addTest(
            'New Format Backup Recognition',
            'Verify backups already in new format are recognized',
            async () => {
                const newBackup = {
                    version: '1.0',
                    timestamp: '2024-01-01T00:00:00.000Z',
                    tables: {
                        tom_analytics_data: '[{"name":"Test"}]'
                    }
                };
                
                try {
                    const result = testSuite.migrationUtility.importLegacyBackup(newBackup);
                    
                    if (result.version !== newBackup.version) {
                        return { passed: false, message: 'New format not recognized' };
                    }
                    
                    return { passed: true, message: 'New format backup recognized correctly' };
                } catch (error) {
                    return { passed: false, message: error.message };
                }
            }
        );
        
        // Test 9: Migration rollback
        testSuite.addTest(
            'Migration Rollback',
            'Verify migration can be rolled back successfully',
            async () => {
                setupTestEnvironment();
                
                // Get original data
                const originalData = localStorage.getItem('tom_analytics_data');
                
                // Run migration
                testSuite.migrationUtility.migrate();
                
                // Rollback
                const success = testSuite.migrationUtility.rollbackMigration();
                
                if (!success) {
                    return { passed: false, message: 'Rollback failed' };
                }
                
                // Verify migration flag is removed
                if (localStorage.getItem('migration_complete') === 'true') {
                    return { passed: false, message: 'Migration flag not removed' };
                }
                
                return { passed: true, message: 'Migration rolled back successfully' };
            }
        );
        
        // Test 10: Migration status reporting
        testSuite.addTest(
            'Migration Status Reporting',
            'Verify migration status is reported correctly',
            async () => {
                setupTestEnvironment();
                
                // Before migration
                let status = testSuite.migrationUtility.getMigrationStatus();
                
                if (status.migrationComplete) {
                    return { passed: false, message: 'Status shows complete before migration' };
                }
                
                if (!status.hasLegacyData) {
                    return { passed: false, message: 'Legacy data not detected' };
                }
                
                // After migration
                testSuite.migrationUtility.migrate();
                status = testSuite.migrationUtility.getMigrationStatus();
                
                if (!status.migrationComplete) {
                    return { passed: false, message: 'Status not updated after migration' };
                }
                
                return { passed: true, message: 'Migration status reported correctly' };
            }
        );
        
        // Test 11: Table configuration compatibility
        testSuite.addTest(
            'Table Configuration Compatibility',
            'Verify all 6 existing tables are in configuration',
            async () => {
                try {
                    const configSystem = new TableConfigSystem();
                    await configSystem.loadConfig();
                    
                    const tables = configSystem.getAllTables();
                    
                    if (tables.length < 6) {
                        return { passed: false, message: `Only ${tables.length} tables found, expected 6` };
                    }
                    
                    // Check for all legacy table IDs
                    const expectedIds = ['vti-compliance', 'vti-dpmo', 'ta-idle-time', 'seal-validation', 'ppo-compliance', 'andon-response-time'];
                    
                    for (const id of expectedIds) {
                        const table = configSystem.getTableConfig(id);
                        if (!table) {
                            return { passed: false, message: `Table ${id} not found in configuration` };
                        }
                    }
                    
                    return { passed: true, message: 'All 6 tables present in configuration' };
                } catch (error) {
                    return { passed: false, message: error.message };
                }
            }
        );
        
        // Test 12: Storage key mapping
        testSuite.addTest(
            'Storage Key Mapping',
            'Verify storage keys are correctly mapped',
            async () => {
                try {
                    const configSystem = new TableConfigSystem();
                    await configSystem.loadConfig();
                    
                    const expectedMappings = [
                        { tableId: 'vti-compliance', storageKey: 'tom_analytics_data' },
                        { tableId: 'vti-dpmo', storageKey: 'tom_analytics_data_2' },
                        { tableId: 'ta-idle-time', storageKey: 'tom_analytics_data_3' },
                        { tableId: 'seal-validation', storageKey: 'tom_analytics_data_4' },
                        { tableId: 'ppo-compliance', storageKey: 'tom_analytics_data_5' },
                        { tableId: 'andon-response-time', storageKey: 'tom_analytics_data_6' }
                    ];
                    
                    for (const mapping of expectedMappings) {
                        const table = configSystem.getTableConfig(mapping.tableId);
                        if (table.storageKey !== mapping.storageKey) {
                            return { passed: false, message: `${mapping.tableId} has wrong storage key: ${table.storageKey}` };
                        }
                    }
                    
                    return { passed: true, message: 'All storage keys mapped correctly' };
                } catch (error) {
                    return { passed: false, message: error.message };
                }
            }
        );
        
        // Run all tests
        async function runAllTests() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('detailedLog').textContent = '';
            await testSuite.runAll();
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            testSuite.log('Backward compatibility test suite loaded', 'info');
            testSuite.log('Click "Run All Tests" to begin', 'info');
        });
    </script>
</body>
</html>
