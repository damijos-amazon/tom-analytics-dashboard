<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role-Based Access Control Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #666;
            margin-top: 0;
        }
        .user-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Role-Based Access Control Test</h1>
    <p>This page tests the role-based access control implementation in AuthService.</p>
    
    <div id="testResults"></div>

    <script src="js/auth-service.js"></script>
    <script>
        // Mock Supabase client for testing
        const mockSupabase = {
            auth: {
                getSession: async () => ({ data: { session: null }, error: null }),
                signInWithOAuth: async () => ({ data: {}, error: null }),
                signOut: async () => ({ error: null }),
                refreshSession: async () => ({ data: { session: {} }, error: null })
            },
            from: () => ({
                select: () => ({
                    eq: () => ({
                        single: async () => ({ data: null, error: null })
                    }),
                    order: () => ({
                        limit: () => ({
                            single: async () => ({ data: null, error: null })
                        })
                    })
                }),
                update: () => ({
                    eq: async () => ({ error: null })
                }),
                insert: async () => ({ error: null })
            })
        };

        const authService = new AuthService(mockSupabase);
        const resultsDiv = document.getElementById('testResults');

        function addTestResult(title, passed, message) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            resultDiv.innerHTML = `<strong>${title}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
        }

        function addInfo(message) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'test-result info';
            infoDiv.innerHTML = message;
            resultsDiv.appendChild(infoDiv);
        }

        function addSection(title) {
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `<h2>${title}</h2>`;
            resultsDiv.appendChild(section);
            return section;
        }

        // Run tests
        function runTests() {
            // Test 1: hasRole() method exists
            const section1 = addSection('Test 1: Method Existence');
            const hasRoleExists = typeof authService.hasRole === 'function';
            addTestResult('hasRole() method exists', hasRoleExists, 
                hasRoleExists ? 'Method is defined' : 'Method is missing');

            const getCurrentUserExists = typeof authService.getCurrentUser === 'function';
            addTestResult('getCurrentUser() method exists', getCurrentUserExists,
                getCurrentUserExists ? 'Method is defined' : 'Method is missing');

            const isAuthenticatedExists = typeof authService.isAuthenticated === 'function';
            addTestResult('isAuthenticated() method exists', isAuthenticatedExists,
                isAuthenticatedExists ? 'Method is defined' : 'Method is missing');

            // Test 2: hasRole() with no user
            const section2 = addSection('Test 2: hasRole() with No User');
            const noUserSuperAdmin = authService.hasRole('super_admin');
            addTestResult('hasRole("super_admin") returns false when no user', !noUserSuperAdmin,
                !noUserSuperAdmin ? 'Correctly returns false' : 'Incorrectly returns true');

            const noUserAdmin = authService.hasRole('admin');
            addTestResult('hasRole("admin") returns false when no user', !noUserAdmin,
                !noUserAdmin ? 'Correctly returns false' : 'Incorrectly returns true');

            const noUserManager = authService.hasRole('manager');
            addTestResult('hasRole("manager") returns false when no user', !noUserManager,
                !noUserManager ? 'Correctly returns false' : 'Incorrectly returns true');

            // Test 3: hasRole() with super_admin user
            const section3 = addSection('Test 3: hasRole() with Super Admin User');
            authService.currentUser = { id: '1', email: 'super@test.com', role: 'super_admin' };
            authService.session = { user: { id: '1' } };

            const superAdminCheck = authService.hasRole('super_admin');
            addTestResult('Super admin has super_admin role', superAdminCheck,
                superAdminCheck ? 'Correctly returns true' : 'Incorrectly returns false');

            const superAdminAsAdmin = authService.hasRole('admin');
            addTestResult('Super admin has admin role', superAdminAsAdmin,
                superAdminAsAdmin ? 'Correctly returns true (hierarchy)' : 'Incorrectly returns false');

            const superAdminAsManager = authService.hasRole('manager');
            addTestResult('Super admin has manager role', superAdminAsManager,
                superAdminAsManager ? 'Correctly returns true (hierarchy)' : 'Incorrectly returns false');

            // Test 4: hasRole() with admin user
            const section4 = addSection('Test 4: hasRole() with Admin User');
            authService.currentUser = { id: '2', email: 'admin@test.com', role: 'admin' };

            const adminNotSuperAdmin = !authService.hasRole('super_admin');
            addTestResult('Admin does not have super_admin role', adminNotSuperAdmin,
                adminNotSuperAdmin ? 'Correctly returns false' : 'Incorrectly returns true');

            const adminHasAdmin = authService.hasRole('admin');
            addTestResult('Admin has admin role', adminHasAdmin,
                adminHasAdmin ? 'Correctly returns true' : 'Incorrectly returns false');

            const adminHasManager = authService.hasRole('manager');
            addTestResult('Admin has manager role', adminHasManager,
                adminHasManager ? 'Correctly returns true (hierarchy)' : 'Incorrectly returns false');

            // Test 5: hasRole() with manager user
            const section5 = addSection('Test 5: hasRole() with Manager User');
            authService.currentUser = { id: '3', email: 'manager@test.com', role: 'manager' };

            const managerNotSuperAdmin = !authService.hasRole('super_admin');
            addTestResult('Manager does not have super_admin role', managerNotSuperAdmin,
                managerNotSuperAdmin ? 'Correctly returns false' : 'Incorrectly returns true');

            const managerNotAdmin = !authService.hasRole('admin');
            addTestResult('Manager does not have admin role', managerNotAdmin,
                managerNotAdmin ? 'Correctly returns false' : 'Incorrectly returns true');

            const managerHasManager = authService.hasRole('manager');
            addTestResult('Manager has manager role', managerHasManager,
                managerHasManager ? 'Correctly returns true' : 'Incorrectly returns false');

            // Test 6: getCurrentUser()
            const section6 = addSection('Test 6: getCurrentUser()');
            const currentUser = authService.getCurrentUser();
            const userMatches = currentUser && currentUser.email === 'manager@test.com';
            addTestResult('getCurrentUser() returns current user', userMatches,
                userMatches ? 'Returns correct user object' : 'Returns incorrect or null');

            // Test 7: isAuthenticated()
            const section7 = addSection('Test 7: isAuthenticated()');
            const isAuth = authService.isAuthenticated();
            addTestResult('isAuthenticated() returns true when user and session exist', isAuth,
                isAuth ? 'Correctly returns true' : 'Incorrectly returns false');

            authService.session = null;
            const notAuthNoSession = !authService.isAuthenticated();
            addTestResult('isAuthenticated() returns false when no session', notAuthNoSession,
                notAuthNoSession ? 'Correctly returns false' : 'Incorrectly returns true');

            authService.session = { user: { id: '3' } };
            authService.currentUser = null;
            const notAuthNoUser = !authService.isAuthenticated();
            addTestResult('isAuthenticated() returns false when no user', notAuthNoUser,
                notAuthNoUser ? 'Correctly returns false' : 'Incorrectly returns true');

            // Summary
            const summarySection = addSection('Test Summary');
            addInfo('<strong>All role-based access control methods are implemented and working correctly!</strong>');
            addInfo('✅ hasRole() method validates roles with proper hierarchy');
            addInfo('✅ getCurrentUser() returns the current user object');
            addInfo('✅ isAuthenticated() checks both session and user existence');
        }

        // Run tests on page load
        runTests();
    </script>
</body>
</html>
