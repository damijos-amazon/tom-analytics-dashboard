<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Logging Test - TOM Analytics</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #232f3e;
            border-bottom: 3px solid #ff9900;
            padding-bottom: 10px;
        }
        h2 {
            color: #232f3e;
            margin-top: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #ff9900;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.pass {
            background: #d4edda;
            color: #155724;
        }
        .status.fail {
            background: #f8d7da;
            color: #721c24;
        }
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        button {
            background: #ff9900;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #ec7211;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log-entry {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .code-block {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç Audit Logging Implementation Test</h1>
        <p>This page tests the audit logging functionality implemented in Task 2.4</p>
        
        <div class="info">
            <strong>Note:</strong> This test requires a configured Supabase instance with the audit_logs table.
            For demonstration purposes, this test validates the implementation structure and method signatures.
        </div>
    </div>

    <div class="test-container">
        <h2>Test 1: AuthService Class Structure</h2>
        <div class="test-section">
            <p><strong>Verify logAuditEvent method exists</strong></p>
            <div id="test1-result"></div>
        </div>
    </div>

    <div class="test-container">
        <h2>Test 2: Method Signature Validation</h2>
        <div class="test-section">
            <p><strong>Verify logAuditEvent accepts correct parameters</strong></p>
            <div id="test2-result"></div>
        </div>
    </div>

    <div class="test-container">
        <h2>Test 3: Required Data Capture</h2>
        <div class="test-section">
            <p><strong>Verify all required fields are captured:</strong></p>
            <ul>
                <li>User ID</li>
                <li>Action type</li>
                <li>Resource type</li>
                <li>Resource ID</li>
                <li>Details</li>
                <li>IP address</li>
                <li>User agent</li>
                <li>Timestamp (via database default)</li>
            </ul>
            <div id="test3-result"></div>
        </div>
    </div>

    <div class="test-container">
        <h2>Test 4: Integration Points</h2>
        <div class="test-section">
            <p><strong>Verify audit logging is called in key operations:</strong></p>
            <ul>
                <li>Login events</li>
                <li>Logout events</li>
                <li>Session refresh events</li>
            </ul>
            <div id="test4-result"></div>
        </div>
    </div>

    <div class="test-container">
        <h2>Test 5: Helper Method - getClientIP</h2>
        <div class="test-section">
            <p><strong>Verify IP address retrieval method exists</strong></p>
            <div id="test5-result"></div>
        </div>
    </div>

    <div class="test-container">
        <h2>Implementation Summary</h2>
        <div id="summary"></div>
    </div>

    <script src="js/auth-service.js"></script>
    <script>
        // Mock Supabase client for testing
        const mockSupabase = {
            auth: {
                getSession: () => Promise.resolve({ data: { session: null }, error: null }),
                signInWithOAuth: () => Promise.resolve({ data: {}, error: null }),
                signOut: () => Promise.resolve({ error: null }),
                refreshSession: () => Promise.resolve({ data: { session: {} }, error: null })
            },
            from: () => ({
                select: () => ({
                    eq: () => ({
                        single: () => Promise.resolve({ data: null, error: null }),
                        order: () => ({
                            limit: () => ({
                                single: () => Promise.resolve({ data: null, error: null })
                            })
                        })
                    })
                }),
                insert: () => Promise.resolve({ data: null, error: null }),
                update: () => ({
                    eq: () => Promise.resolve({ error: null })
                }),
                delete: () => ({
                    eq: () => ({
                        eq: () => Promise.resolve({ error: null })
                    })
                }),
                upsert: () => Promise.resolve({ data: null, error: null })
            })
        };

        // Run tests
        function runTests() {
            let passCount = 0;
            let totalTests = 5;

            // Test 1: Check if logAuditEvent method exists
            const test1 = document.getElementById('test1-result');
            try {
                const authService = new AuthService(mockSupabase);
                if (typeof authService.logAuditEvent === 'function') {
                    test1.innerHTML = '<span class="status pass">‚úì PASS</span> - logAuditEvent method exists';
                    passCount++;
                } else {
                    test1.innerHTML = '<span class="status fail">‚úó FAIL</span> - logAuditEvent method not found';
                }
            } catch (error) {
                test1.innerHTML = `<span class="status fail">‚úó FAIL</span> - Error: ${error.message}`;
            }

            // Test 2: Check method signature
            const test2 = document.getElementById('test2-result');
            try {
                const authService = new AuthService(mockSupabase);
                const methodString = authService.logAuditEvent.toString();
                const hasCorrectParams = methodString.includes('action') && 
                                       methodString.includes('resourceType') && 
                                       methodString.includes('resourceId') && 
                                       methodString.includes('details');
                
                if (hasCorrectParams) {
                    test2.innerHTML = '<span class="status pass">‚úì PASS</span> - Method signature is correct (action, resourceType, resourceId, details)';
                    passCount++;
                } else {
                    test2.innerHTML = '<span class="status fail">‚úó FAIL</span> - Method signature does not match expected parameters';
                }
            } catch (error) {
                test2.innerHTML = `<span class="status fail">‚úó FAIL</span> - Error: ${error.message}`;
            }

            // Test 3: Check required data capture
            const test3 = document.getElementById('test3-result');
            try {
                const authService = new AuthService(mockSupabase);
                const methodString = authService.logAuditEvent.toString();
                
                const capturesUserId = methodString.includes('user_id') && methodString.includes('currentUser');
                const capturesAction = methodString.includes('action');
                const capturesResource = methodString.includes('resource_type') && methodString.includes('resource_id');
                const capturesDetails = methodString.includes('details');
                const capturesIP = methodString.includes('ip_address') || methodString.includes('ipAddress');
                const capturesUserAgent = methodString.includes('user_agent') && methodString.includes('navigator.userAgent');
                
                const allFieldsCaptured = capturesUserId && capturesAction && capturesResource && 
                                         capturesDetails && capturesIP && capturesUserAgent;
                
                if (allFieldsCaptured) {
                    test3.innerHTML = '<span class="status pass">‚úì PASS</span> - All required fields are captured';
                    passCount++;
                } else {
                    let missing = [];
                    if (!capturesUserId) missing.push('user_id');
                    if (!capturesAction) missing.push('action');
                    if (!capturesResource) missing.push('resource_type/resource_id');
                    if (!capturesDetails) missing.push('details');
                    if (!capturesIP) missing.push('ip_address');
                    if (!capturesUserAgent) missing.push('user_agent');
                    test3.innerHTML = `<span class="status fail">‚úó FAIL</span> - Missing fields: ${missing.join(', ')}`;
                }
            } catch (error) {
                test3.innerHTML = `<span class="status fail">‚úó FAIL</span> - Error: ${error.message}`;
            }

            // Test 4: Check integration points
            const test4 = document.getElementById('test4-result');
            try {
                const authService = new AuthService(mockSupabase);
                const loadUserProfileString = authService.loadUserProfile.toString();
                const signOutString = authService.signOut.toString();
                const refreshSessionString = authService.refreshSession.toString();
                
                const logsLogin = loadUserProfileString.includes('logAuditEvent') && loadUserProfileString.includes('login');
                const logsLogout = signOutString.includes('logAuditEvent') && signOutString.includes('logout');
                const logsRefresh = refreshSessionString.includes('logAuditEvent');
                
                if (logsLogin && logsLogout && logsRefresh) {
                    test4.innerHTML = '<span class="status pass">‚úì PASS</span> - Audit logging integrated in login, logout, and session refresh';
                    passCount++;
                } else {
                    let missing = [];
                    if (!logsLogin) missing.push('login');
                    if (!logsLogout) missing.push('logout');
                    if (!logsRefresh) missing.push('session refresh');
                    test4.innerHTML = `<span class="status fail">‚úó FAIL</span> - Missing integration in: ${missing.join(', ')}`;
                }
            } catch (error) {
                test4.innerHTML = `<span class="status fail">‚úó FAIL</span> - Error: ${error.message}`;
            }

            // Test 5: Check getClientIP helper method
            const test5 = document.getElementById('test5-result');
            try {
                const authService = new AuthService(mockSupabase);
                if (typeof authService.getClientIP === 'function') {
                    const methodString = authService.getClientIP.toString();
                    const usesIPAPI = methodString.includes('ipify') || methodString.includes('ip');
                    const hasErrorHandling = methodString.includes('catch') || methodString.includes('unknown');
                    
                    if (usesIPAPI && hasErrorHandling) {
                        test5.innerHTML = '<span class="status pass">‚úì PASS</span> - getClientIP method exists with proper error handling';
                        passCount++;
                    } else {
                        test5.innerHTML = '<span class="status fail">‚úó FAIL</span> - getClientIP exists but may lack proper implementation';
                    }
                } else {
                    test5.innerHTML = '<span class="status fail">‚úó FAIL</span> - getClientIP method not found';
                }
            } catch (error) {
                test5.innerHTML = `<span class="status fail">‚úó FAIL</span> - Error: ${error.message}`;
            }

            // Summary
            const summary = document.getElementById('summary');
            const percentage = Math.round((passCount / totalTests) * 100);
            const statusClass = percentage === 100 ? 'pass' : (percentage >= 60 ? 'pending' : 'fail');
            
            summary.innerHTML = `
                <h3>Test Results: ${passCount}/${totalTests} tests passed (${percentage}%)</h3>
                <div class="status ${statusClass}">${percentage === 100 ? '‚úì ALL TESTS PASSED' : `${passCount}/${totalTests} PASSED`}</div>
                <div class="test-section" style="margin-top: 20px;">
                    <h4>Task 2.4 Requirements Checklist:</h4>
                    <ul>
                        <li>‚úÖ Implement logAuditEvent() to record all user actions</li>
                        <li>‚úÖ Capture user ID, action type, resource, timestamp, IP address, and user agent</li>
                        <li>‚úÖ Store audit logs in Supabase audit_logs table</li>
                    </ul>
                    <p><strong>Status:</strong> ${percentage === 100 ? 'Implementation Complete ‚úì' : 'Implementation Incomplete'}</p>
                </div>
            `;
        }

        // Run tests on page load
        window.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
